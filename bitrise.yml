format_version: 1.2.0
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

trigger_map:
- pattern: "*"
  is_pull_request_allowed: true
  workflow: ci

workflows:
  ci:
    title: Bitrise Init CI
    description: Bitrise Init CI
    before_run:
    - _prepare_and_setup
    after_run:
    - test
    steps:
    - script:
        title: Print go environment
        inputs:
        - content: |-
            set -x
            go version
            echo $GO15VENDOREXPERIMENT
    - script:
        title: Export go files to test
        inputs:
        - content: |-
            set -e
            set -x
            no_vendor_paths="$(go list ./... | grep -v vendor)"
            envman add --key GOLIST_WITHOUT_VENDOR --value "$no_vendor_paths"
    - script:
        title: Err check
        inputs:
        - content: errcheck -asserts=true -blank=true $GOLIST_WITHOUT_VENDOR
    - script:
        title: Go lint
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            while read -r line; do
              echo "-> Linting: $line"
              golint_out="$(golint $line)"
              if [[ "${golint_out}" != "" ]] ; then
                echo "=> Golint issues found:"
                echo "${golint_out}"
                exit 1
              fi
            done <<< "$GOLIST_WITHOUT_VENDOR"
    - script:
        title: Go test
        inputs:
        - content: go test ./...

  test:
    title: Bitrise Init Test
    description: Bitrise Init Test
    before_run:
    - _install_init_tool
    steps:
    - script:
        title: "Scane test: sample-apps-ios-watchkit"
        inputs:
        - content: |-
            #!/bin/bash
            set -x

            rm -rf ./_tmp
            SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-io/sample-apps-ios-watchkit.git
            git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
            $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json
    # - script:
    #     title: "Scane test: android-sdk22-no-gradlew"
    #     inputs:
    #     - content: |-
    #         #!/bin/bash
    #         set -x
    #
    #         rm -rf ./_tmp
    #         SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-samples/android-sdk22-no-gradlew.git
    #         git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
    #         $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json
    - script:
        title: "Scane test: sample-apps-android-sdk22"
        inputs:
        - content: |-
            #!/bin/bash
            set -x

            rm -rf ./_tmp
            SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-samples/sample-apps-android-sdk22.git
            git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
            $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json
    - script:
        title: "Scane test: sample-apps-xamarin-ios"
        inputs:
        - content: |-
            #!/bin/bash
            set -x

            rm -rf ./_tmp
            SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-io/sample-apps-xamarin-ios.git
            git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
            $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json
    - script:
        title: "Scane test: android-non-executable-gradlew"
        inputs:
        - content: |-
            #!/bin/bash
            set -x

            rm -rf ./_tmp
            SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-samples/android-non-executable-gradlew.git
            git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
            $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json
    - script:
        title: "Scane test: sample-apps-xamarin-android"
        inputs:
        - content: |-
            #!/bin/bash
            set -x

            rm -rf ./_tmp
            SAMPLE_APP_REPOSITORY_URL=https://github.com/bitrise-io/sample-apps-xamarin-android.git
            git clone $SAMPLE_APP_REPOSITORY_URL ./_tmp/sample-repo
            $SCANNER_BIN --ci config --dir ./_tmp/sample-repo --output-dir ./_tmp/output --format json

  _install_init_tool:
    title: Installs bitrise-init tool
    description: |
        Installs bitrise-init tool
    steps:
    - script:
        inputs:
        - content: |-
            #!/bin/bash

            #
            # Create scanner bin
            echo "Create scanner bin..."

            export GO15VENDOREXPERIMENT="1"
            export GOPATH="$GOPATH:$THIS_SCRIPTDIR/go/"
            export ARCH=x86_64
            export GOARCH=amd64

            current_os=$(uname -s)
            if [[ "$current_os" == "Darwin" ]] ; then
              export GOOS=darwin
            elif [[ "$current_os" == "Linux" ]]; then
              export GOOS=linux
            else
              echo "step runs on unsupported os: $current_os"
              exit 1
            fi

            tmp_dir=$(mktemp -d)
            current_dir=$(pwd)
            bin_pth="$tmp_dir/scanner"

            go build -o "$bin_pth"

            echo "ceated at: ${bin_pth}"
            envman add --key SCANNER_BIN --value $bin_pth


  _prepare_and_setup:
    title: Prepare bitrise and install testing tools
    description: |
        Prepares the environment for testing
    steps:
    - script:
        title: Install testing tools
        run_if: ".IsCI"
        inputs:
        - content: |-
            #!/bin/bash
            set -e
            set -x

            brew update

            # Install dependencies
            go get -u github.com/tools/godep

            # Check for unhandled errors
            go get -u github.com/kisielk/errcheck

            # Go lint
            go get -u github.com/golang/lint/golint
